<app-volver></app-volver>
<div class="evento-page">
  <div class="top-bar"><br>
    <h2>Eventos de Subasta</h2>
    <button class="btn-new"
            [disabled]="hayEventoAbierto"
            (click)="toggleForm()">
      <i class="fa-solid fa-plus"></i>
      Nuevo evento
    </button>
  </div>

  <strong>
    <p class="warning" *ngIf="hayEventoAbierto">
      Ya existe un evento abierto. Debes cerrarlo para crear uno nuevo.
    </p>
  </strong>

  <div class="lista-eventos">

    <div class="evento-row" *ngFor="let e of eventos">

      <div class="row-left">
        <div class="fecha-badge">
          <span class="dia">{{ e.fechaEvento | date:'dd' }}</span>
          <span class="mes">{{ e.fechaEvento | date:'MMM' }}</span>
        </div>

        <div class="evento-info">
          <h3>{{ e.nombre }}</h3>
          <p>
            <i class="fa-regular fa-clock"></i>
            {{ formatearHora(e.horaInicio) }} •
            {{ e.duracionSubastaMinutos }} min + {{ e.descansoMinutos }} min descanso
          </p>
          <p>
            <b>Subastas aceptadas:</b>
            {{ getTotalSubastas(e.id) }}
          </p>
        </div>
      </div>

      <div class="row-right">

        <span class="estado-chip"
              [class.abierto]="e.estado === 'ABIERTO'"
              [class.cerrado]="e.estado === 'CERRADO'">
          {{ e.estado }}
        </span>

        <div class="acciones">

          <button class="icon-btn edit"
                  (click)="seleccionar(e); toggleForm()">
            <i class="fa-solid fa-pen"></i>
          </button>

          <button class="icon-btn lock"
                  *ngIf="e.estado === 'ABIERTO'"
                  (click)="cerrarManual(e.id)">
            <i class="fa-solid fa-lock"></i>
          </button>

          <button class="icon-btn organize"
                  (click)="irAOrganizarSubastas(e.id)">
            <i class="fa-solid fa-list"></i>
          </button>

          <button class="icon-btn organize"
                  (click)="eventoPrediccion = e; showPrediccion = true">
            <i class="fa-solid fa-chart-line"></i>
          </button>

          <button class="icon-btn delete"
                  [disabled]="e.estado === 'ABIERTO'"
                  (click)="eliminar(e.id)">
            <i class="fa-solid fa-trash"></i>
          </button>

        </div>
      </div>

    </div>

  </div>

  <div class="drawer-overlay" *ngIf="showForm" (click)="toggleForm()"></div>

  <div class="drawer" [class.open]="showForm">

    <div class="drawer-header">
      <h3>{{ editando ? 'Editar evento' : 'Crear nuevo evento' }}</h3>
      <button class="close-btn" (click)="toggleForm()">×</button>
    </div>

    <div class="drawer-body">

      <div class="form-section">
        <label>Nombre del evento</label>
        <input [(ngModel)]="evento.nombre" />
      </div>

      <div class="form-grid">

        <div class="form-section">
          <label>Fecha del evento</label>
          <input type="date" [(ngModel)]="evento.fechaEvento" />
        </div>

        <div class="form-section">
          <label>Hora de inicio</label>
          <input type="time" [(ngModel)]="evento.horaInicio" />
        </div>

        <div class="form-section">
          <label>Duración por subasta</label>
          <input type="number" [(ngModel)]="evento.duracionSubastaMinutos" />
        </div>

        <div class="form-section">
          <label>Descanso</label>
          <input type="number" [(ngModel)]="evento.descansoMinutos" />
        </div>

      </div>

    </div>

    <div class="drawer-footer">
      <button class="btn-save" *ngIf="!editando" (click)="guardar()">Guardar evento</button>
      <button class="btn-save" *ngIf="editando" (click)="actualizar()">Actualizar evento</button>
      <button class="btn-cancel" (click)="toggleForm()">Cancelar</button>
    </div>

  </div>

  <div class="modal" *ngIf="showPrediccion">
    <div class="modal-bg" (click)="showPrediccion=false"></div>

    <div class="modal-content">
      <h3>Predicción del evento</h3>

      <p>
        <b>Subastas aceptadas:</b>
        {{ getTotalSubastas(eventoPrediccion.id) }}
      </p>

      <p>
        <b>Inicio:</b>
        {{ formatearHora(eventoPrediccion.horaInicio) }}
      </p>

      <p>
        <b>Fin estimado:</b>
        {{ calcularHoraFin(eventoPrediccion) }}
      </p>

      <button class="btn-save" (click)="showPrediccion=false">
        Cerrar
      </button>
    </div>
  </div>

</div>
